# AIProxy 代理服务详细需求文档

## 1. 项目概述

### 1.1 项目背景
公司内部用户和产品线需要调用第三方AI平台（如阿里云百炼、OpenAI等）的API接口。出于安全管控考虑，需要实现一个代理服务来统一管理API-Key，避免直接暴露第三方平台的API-Key给用户，防止离职员工继续使用公司API资源。

### 1.2 项目目标
- 实现统一的API代理服务，支持多种AI平台接入
- 建立安全的API-Key管理体系
- 提供用户管理和使用量统计功能
- 支持三方平台SDK或OpenAI SDK接入，支持HTTP、WebSocket、WebRTC协议

### 1.3 核心价值
- **安全管控**：集中管理API-Key，可随时撤销权限
- **成本控制**：避免离职员工继续使用公司API资源
- **统一接入**：为各产品线提供统一的API接入方式
- **权限管理**：支持细粒度的访问控制

## 2. 功能需求

### 2.1 核心代理功能

#### 2.1.1 代理转发
- 支持用户 → 代理服务 → 渠道API的调用链路
- 支持HTTP和WebSocket两种协议
- 支持多渠道并发访问

#### 2.1.2 API-Key替换
- 接收用户请求中的Proxy-Key
- 将Proxy-Key替换为对应的渠道API-Key
- 转发请求到目标渠道

#### 2.1.3 协议支持
- HTTP协议：完全支持，包括GET、POST、PUT、DELETE等
- WebSocket协议：支持握手阶段API-Key替换，数据帧直接转发
- 支持标准RESTful API调用

### 2.2 API-Key管理功能

#### 2.2.1 Proxy-Key管理
- Proxy-Key的创建、删除、修改、查询
- Proxy-Key状态管理（启用/禁用）
- Proxy-Key与用户的绑定关系

#### 2.2.2 渠道API-Key管理
- 渠道API-Key的创建、删除、修改、查询
- 渠道API-Key明文存储
- 渠道配置信息管理（基础URL、超时时间等）
- 渠道状态管理（启用/禁用）

#### 2.2.3 映射关系管理
- Proxy-Key与渠道API-Key的映射关系
- 支持一个Proxy-Key映射到多个渠道
- 支持渠道优先级配置

### 2.3 用户管理功能

#### 2.3.1 用户基础管理
- 用户的创建、删除、修改、查询
- 用户状态管理（启用/禁用）
- 用户基本信息管理（姓名、部门、联系方式等）

#### 2.3.2 用户权限管理
- 用户与Proxy-Key的一对一绑定
- 用户可访问的渠道权限控制
- 用户使用配额管理

#### 2.3.3 用户认证
- 支持基于Proxy-Key的认证方式
- 支持IP白名单控制（可选）

### 2.4 使用量统计功能

#### 2.4.1 统计维度
- 用户维度：每个用户的使用量统计
- 渠道维度：每个渠道的使用量统计
- 时间维度：按小时、天、月统计使用情况
- 接口维度：按具体API接口统计使用情况

#### 2.4.2 统计指标
- 请求次数统计
- 请求成功率统计
- 响应时间统计
- 错误类型统计

#### 2.4.3 报表功能
- 支持统计报表导出
- 支持图表展示
- 支持告警配置

## 3. 功能点列表

| 一级模块 | 二级模块（功能点） | 重要程度 | 优先级 | 描述 |
|----------|-------------------|----------|--------|------|
| **核心代理功能** | HTTP协议代理转发 | 核心功能 | P0 | 支持HTTP请求的代理转发和API-Key替换，包括GET、POST、PUT、DELETE等标准HTTP方法 |
| **核心代理功能** | Proxy-Key认证 | 核心功能 | P0 | 基于Proxy-Key的用户认证机制，验证用户身份和权限 |
| **核心代理功能** | API-Key替换 | 核心功能 | P0 | 将用户请求中的Proxy-Key替换为对应的渠道API-Key |
| **核心代理功能** | 基础日志记录 | 核心功能 | P0 | 记录所有API访问日志，包括请求时间、用户、渠道、响应状态等 |
| **核心代理功能** | 配置文件加载 | 核心功能 | P0 | Lua脚本定期加载配置文件，支持配置热重载 |
| **核心代理功能** | WebSocket协议支持 | 重要功能 | P1 | 支持WebSocket握手阶段的API-Key替换，数据帧直接转发 |
| **核心代理功能** | 多渠道支持 | 重要功能 | P1 | 支持多个AI平台渠道，如阿里云百炼、OpenAI等 |
| **核心代理功能** | 配置热重载 | 重要功能 | P1 | 配置文件变更后自动重载，无需重启服务 |
| **核心代理功能** | 负载均衡 | 增强功能 | P2 | 支持多实例部署和负载均衡 |
| **核心代理功能** | 健康检查 | 增强功能 | P2 | 定期检查渠道API的可用性和响应时间 |
| **API-Key管理** | Proxy-Key管理 | 核心功能 | P0 | Proxy-Key的创建、删除、修改、查询和状态管理 |
| **API-Key管理** | 渠道API-Key管理 | 核心功能 | P0 | 渠道API-Key的配置、存储和管理 |
| **API-Key管理** | 映射关系管理 | 核心功能 | P0 | Proxy-Key与渠道API-Key的映射关系配置 |
| **API-Key管理** | 渠道配置管理 | 重要功能 | P1 | 渠道基础URL、超时时间、重试策略等配置管理 |
| **API-Key管理** | 渠道状态管理 | 重要功能 | P1 | 渠道启用/禁用状态管理和监控 |
| **API-Key管理** | 渠道优先级配置 | 增强功能 | P2 | 支持渠道优先级配置，实现故障转移 |
| **API-Key管理** | 渠道配额管理 | 增强功能 | P2 | 为不同渠道设置使用配额和限制 |
| **用户管理** | 用户基础管理 | 重要功能 | P1 | 用户的创建、删除、修改、查询和状态管理 |
| **用户管理** | 用户信息管理 | 重要功能 | P1 | 用户姓名、部门、联系方式等基本信息管理 |
| **用户管理** | 用户权限控制 | 增强功能 | P2 | 细粒度的用户权限管理，控制用户可访问的渠道 |
| **用户管理** | 用户使用配额 | 增强功能 | P2 | 用户使用量配额控制，防止滥用 |
| **用户管理** | 用户认证机制 | 增强功能 | P2 | 基于Proxy-Key的认证机制，支持IP白名单 |
| **用户管理** | 用户分组管理 | 扩展功能 | P3 | 支持用户分组，便于批量权限管理 |
| **使用量统计** | 基础统计功能 | 重要功能 | P1 | 基础的使用量统计，包括请求次数、成功率等 |
| **使用量统计** | 用户维度统计 | 重要功能 | P1 | 按用户统计使用量，包括请求次数、响应时间等 |
| **使用量统计** | 渠道维度统计 | 重要功能 | P1 | 按渠道统计使用量，包括请求次数、错误率等 |
| **使用量统计** | 时间维度统计 | 增强功能 | P2 | 按小时、天、月统计使用情况 |
| **使用量统计** | 接口维度统计 | 增强功能 | P2 | 按具体API接口统计使用情况 |
| **使用量统计** | 统计报表导出 | 增强功能 | P2 | 支持统计报表导出，包括Excel、PDF等格式 |
| **使用量统计** | 图表展示 | 扩展功能 | P3 | 支持图表展示，包括折线图、柱状图等 |
| **使用量统计** | 告警配置 | 扩展功能 | P3 | 支持使用量告警配置，如超限告警 |
| **监控告警** | 系统监控 | 增强功能 | P2 | 系统性能指标监控，包括CPU、内存、网络等 |
| **监控告警** | 异常告警 | 增强功能 | P2 | 异常访问和错误告警，及时发现问题 |
| **监控告警** | 性能监控 | 增强功能 | P2 | 响应时间、吞吐量等性能指标监控 |
| **监控告警** | 告警通知 | 扩展功能 | P3 | 支持邮件、短信、钉钉等多种告警通知方式 |
| **监控告警** | 监控面板 | 扩展功能 | P3 | 可视化的监控面板，实时展示系统状态 |
| **管理界面** | Web管理界面 | 扩展功能 | P3 | 可视化的配置管理界面，支持在线配置 |
| **管理界面** | 用户管理界面 | 扩展功能 | P3 | 用户信息的可视化管理和操作界面 |
| **管理界面** | 统计展示界面 | 扩展功能 | P3 | 统计数据的可视化展示界面 |
| **管理界面** | 监控展示界面 | 扩展功能 | P3 | 监控数据的可视化展示界面 |
| **数据存储** | 配置文件存储 | 核心功能 | P0 | 使用配置文件存储用户、渠道、映射关系等数据 |
| **数据存储** | 数据库存储 | 扩展功能 | P3 | 从配置文件迁移到数据库存储，支持SQLite/MySQL |
| **数据存储** | 数据备份 | 增强功能 | P2 | 定期备份配置文件和统计数据 |
| **数据存储** | 数据恢复 | 增强功能 | P2 | 支持数据恢复，确保数据安全 |
| **运维工具** | 自动化部署 | 扩展功能 | P3 | 自动化部署和运维工具，简化部署流程 |
| **运维工具** | 多实例部署 | 扩展功能 | P3 | 支持多实例部署，实现高可用 |
| **运维工具** | 故障排查工具 | 增强功能 | P2 | 提供故障排查工具，快速定位问题 |
| **运维工具** | 性能调优工具 | 扩展功能 | P3 | 提供性能调优工具，优化系统性能 |

### 重要程度说明

- **核心功能**：项目成功的基础，必须实现的功能
- **重要功能**：影响用户体验，建议优先实现的功能
- **增强功能**：提升系统能力，可根据需求选择实现
- **扩展功能**：长期规划，为系统扩展做准备

### 优先级说明

- **P0**：必须实现，项目成功的基础
- **P1**：重要，建议优先实现
- **P2**：可选，根据实际需求选择
- **P3**：后期，长期规划功能

## 4. 非功能需求

### 4.1 性能需求
- 支持并发用户数：100+
- 单次请求响应时间：< 100ms（代理层）
- 系统可用性：99.9%
- 支持7x24小时运行

### 4.2 安全需求
- 访问日志记录
- 异常访问告警
- 移除加密存储要求
- 移除文件权限控制要求

### 4.3 可扩展性需求
- 支持新渠道快速接入
- 支持水平扩展
- 支持配置热更新

### 4.4 可维护性需求
- 完善的日志记录
- 监控和告警机制
- 配置管理工具
- 故障排查工具

## 5. 技术实现方案

### 5.1 技术架构
- **代理服务**：OpenResty + Lua脚本
- **配置管理**：配置文件（初期）/ 数据库（后期）
- **监控统计**：日志收集 + 统计分析
- **管理界面**：Web管理界面（后期）

### 5.2 实施策略
**阶段一：核心功能（1-2个月）**
- OpenResty基础配置
- Lua脚本开发
- 配置文件管理
- HTTP协议支持

**阶段二：协议扩展（1个月）**
- WebSocket协议支持
- 多渠道支持
- 性能优化

**阶段三：企业功能（2-3个月）**
- 用户管理功能
- 使用量统计
- 监控集成

**阶段四：管理界面（1-2个月）**
- Web管理界面
- 数据库迁移
- 运维工具

### 5.3 配置文件设计
```yaml
# 用户配置
users:
  user1:
    name: "张三"
    department: "技术部"
    proxy_key: "pk_user1_xxx"
    status: "active"
    channels: ["aliyun", "openai"]
    
  user2:
    name: "李四"
    department: "产品部"
    proxy_key: "pk_user2_xxx"
    status: "active"
    channels: ["aliyun"]

# 渠道配置（明文存储）
channels:
  aliyun:
    name: "阿里云百炼"
    api_key: "sk_aliyun_xxx"
    base_url: "https://dashscope.aliyuncs.com"
    status: "active"
    
  openai:
    name: "OpenAI"
    api_key: "sk_openai_xxx"
    base_url: "https://api.openai.com"
    status: "active"

# 系统配置
system:
  config_reload_interval: 300  # 配置重载间隔（秒）
  log_level: "info"
  max_connections: 1000
```

## 6. 安全设计

### 6.1 基础安全措施
- **基于Proxy-Key认证**：主要认证方式
- **IP白名单**：可选的安全控制
- **访问日志**：记录所有API访问

### 6.2 运维安全
- **配置文件备份**：定期备份配置文件
- **监控告警**：异常访问告警

## 7. 接口设计

### 7.1 代理接口
- **HTTP接口**：支持标准RESTful API
- **WebSocket接口**：支持实时对话
- **认证方式**：基于Proxy-Key的Authorization头

### 7.2 管理接口（后期）
- **用户管理接口**：CRUD操作
- **配置管理接口**：配置查询和更新
- **统计查询接口**：统计数据查询

## 8. 部署方案

### 8.1 系统架构
```
用户 → OpenResty代理 → 渠道API
     ↓
   Lua脚本处理
     ↓
   配置文件/数据库（明文存储）
```

### 8.2 部署要求
- **操作系统**：Linux（CentOS 7+/Ubuntu 18+）
- **OpenResty版本**：1.19.3.1+
- **Lua版本**：5.1+
- **硬件要求**：4核CPU，8GB内存，100GB存储

## 9. 风险评估

### 9.1 技术风险
- **中等风险**：WebSocket协议处理性能
- **低风险**：HTTP协议处理
- **中等风险**：大量配置文件管理
- **低风险**：配置管理实现（最大简化）

### 9.2 缓解措施
- 分阶段实施，先验证核心功能
- 建立完善的测试流程
- 设计良好的配置文件格式
- 准备回滚方案

## 10. 验收标准

### 10.1 功能验收
- [ ] 支持HTTP协议代理转发
- [ ] 支持WebSocket协议代理转发
- [ ] 支持API-Key替换功能
- [ ] 支持用户管理功能
- [ ] 支持使用量统计功能
- [ ] 支持配置文件明文管理

### 10.2 性能验收
- [ ] 并发用户数达到100+
- [ ] 代理层响应时间 < 100ms
- [ ] 系统可用性达到99.9%

### 10.3 安全验收
- [ ] Proxy-Key安全传输
- [ ] 访问日志完整记录
- [ ] 异常访问告警功能
- [ ] 移除加密存储要求
- [ ] 移除文件权限控制要求

## 11. 实施建议

### 11.1 开发阶段规划
1. **第一阶段（P0）**：专注核心功能，确保基础代理服务稳定运行
2. **第二阶段（P1）**：实现重要功能，完善用户体验
3. **第三阶段（P2）**：根据实际需求选择增强功能
4. **第四阶段（P3）**：规划扩展功能，为长期发展做准备

### 11.2 关键成功因素
- 良好的配置文件设计
- 完善的测试和监控
- 分阶段实施策略
- 专业的OpenResty运维人员

### 11.3 项目里程碑
- **里程碑1**：核心代理功能完成，支持HTTP协议
- **里程碑2**：WebSocket协议支持，多渠道接入
- **里程碑3**：用户管理和统计功能完成
- **里程碑4**：Web管理界面和数据库迁移完成

---

**文档版本**：v1.0  
**创建日期**：2025年7月9日  
**最后更新**：2025年7月9日 11:45
**文档状态**：已审核